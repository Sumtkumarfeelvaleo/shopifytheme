{%- assign product = product | default: product_card_product -%}

{% if product != nil %}
  <div class="custom-product-card">
    <div class="product-card-content">
      <a href="{{ product.url }}" class="custom-card__img" style="position: relative; display: block;">
        {% assign img = product.featured_image | default: product.images.first %}
        {% if img %}
          <img src="{{ img | img_url: '400x' }}" alt="{{ img.alt | escape }}" loading="lazy" style="width: 100%; display: block;">
        {% else %}
          <img src="{{ 'placeholder.png' | asset_url }}" alt="No image" style="width: 100%; display: block;">
        {% endif %}

        {% unless product.available %}
          <span class="badge sold-out-badge" style="position: absolute; top: 10px; left: 0px; background: #cccccc; color: #fff; padding: 4px 8px; font-size: 10px; font-weight: 600; text-transform: uppercase; z-index: 2;">
            Sold Out
          </span>
        {% endunless %}
      </a>

      <div class="custom-card__title">
        {{ product.title }}
      </div>

      <div class="custom-card__price">
        {% if product.compare_at_price > product.price %}
          <del>{{ product.compare_at_price | money }}</del>
        {% endif %}
        <span>{{ product.price | money }}</span>
      </div>
    </div>

    {% if product.available %}
      {% form 'product', product, class: 'product-card-form' %}
        {% assign variantCount = product.variants | size %}
        {% if variantCount > 1 %}
          <div class="custom-card__variants" style="display: none;">
            <input type="hidden" name="id" class="selected-variant-id">
            
            <div class="variant-options">
              <span class="pack-of-label">{{ product.options.first }}:</span>
              <div class="variant-circles">
                {% for variant in product.variants %}
                  <button type="button" class="variant-circle" data-variant-id="{{ variant.id }}" {% unless variant.available %}disabled{% endunless %}>
                    {{ variant.option1 }}
                  </button>
                {% endfor %}
              </div>
            </div>

            <div class="variant-actions">
                <button type="submit" class="custom-card__btn button-ATC" data-btn-addtocart disabled>ADD</button>
                <button type="button" class="custom-card__btn cancel-btn">CANCEL</button>
            </div>
          </div>

          <button type="button" class="custom-card__btn quick-add-btn">
              <b>QUICK&nbsp;ADD</b>
          </button>
        {% else %}
          <input type="hidden" name="id" value="{{ product.variants.first.id }}">
          <button type="submit" class="custom-card__btn button-ATC" data-btn-addtocart>
            <b>ADD&nbsp;TO&nbsp;CART</b>
          </button>
        {% endif %}
      {% endform %}
    {% elsif settings.show_notify_form %}
      <a class="custom-card__btn button-ATC is-notify-me" href="#" data-open-notify-popup data-product-handle="{{ product.handle }}" data-product-id="{{ product.id }}" style="background-color: #999999; color: #fff; text-transform: uppercase;">
        <b>NOTIFY ME</b>
      </a>
    {% else %}
      <a class="custom-card__btn button-ATC" href="{{ product.url }}" disabled style="background-color: #cccccc; color: #fff; text-transform: uppercase;">
        SOLD OUT
      </a>
    {% endif %}
  </div>
{% else %}
  <!-- DEBUG: product object is null -->
{% endif %}
